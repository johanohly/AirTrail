datasource db {
  provider   = "postgresql"
  url        = env("DB_URL")
  extensions = [unaccent]
}

generator kysely {
  provider        = "prisma-kysely"
  previewFeatures = ["postgresqlExtensions"]

  output    = "../src/lib/db"
  fileName  = "schema.d.ts"
  camelCase = true
}

model app_config {
  id     Int  @id @default(autoincrement())
  config Json @default("{}")
}

model user {
  id           String  @id
  username     String  @unique
  display_name String
  /// @kyselyType('metric' | 'imperial')
  unit         String
  password     String?

  /// @kyselyType('user' | 'admin' | 'owner')
  role String

  oauth_id String?

  sessions          session[]
  seats             seat[]
  visited_countries visited_country[]
  api_keys          api_key[]
  public_share      public_share[]
}

model airport {
  id           Int     @id @default(autoincrement())
  icao         String
  iata         String?
  lat          Float
  lon          Float
  tz           String
  name         String
  municipality String?
  /// @kyselyType('large_airport' | 'medium_airport' | 'small_airport' | 'heliport' | 'seaplane_base' | 'balloonport' | 'closed')
  type         String
  /// @kyselyType('EU' | 'NA' | 'SA' | 'AS' | 'AF' | 'OC' | 'AN')
  continent    String
  country      String
  custom       Boolean @default(false)

  flights_from flight[] @relation("flights_from")

  flights_to flight[] @relation("flights_to")
}

model aircraft {
  id        Int     @id @default(autoincrement())
  /// ICAO aircraft type code
  name      String
  icao      String?
  source_id String?

  flights flight[]

  @@index([source_id], map: "aircraft_source_id_idx")
}

model airline {
  id        Int     @id @default(autoincrement())
  name      String
  icao      String?
  iata      String?
  icon_path String?
  source_id String?

  flights flight[]

  @@index([source_id], map: "airline_source_id_idx")
}

model flight {
  id        Int     @id @default(autoincrement())
  date      String
  /// YYYY-MM-DDTHH:mm:ss.sssZ (ISO-8601)
  departure String?
  /// YYYY-MM-DDTHH:mm:ss.sssZ (ISO-8601)
  arrival   String?
  /// YYYY-MM-DDTHH:mm:ss.sssZ (ISO-8601)
  departure_scheduled String?
  /// YYYY-MM-DDTHH:mm:ss.sssZ (ISO-8601)
  arrival_scheduled String?
  /// YYYY-MM-DDTHH:mm:ss.sssZ (ISO-8601)
  takeoff_scheduled String?
  /// YYYY-MM-DDTHH:mm:ss.sssZ (ISO-8601)
  takeoff_actual String?
  /// YYYY-MM-DDTHH:mm:ss.sssZ (ISO-8601)
  landing_scheduled String?
  /// YYYY-MM-DDTHH:mm:ss.sssZ (ISO-8601)
  landing_actual String?
  duration  Int?

  flight_number String?
  /// @kyselyType('leisure' | 'business' | 'crew' | 'other')
  flight_reason String?
  aircraft_reg  String?
  note          String?

  from_id     Int?
  to_id       Int?
  aircraft_id Int?
  airline_id  Int?

  from     airport?  @relation("flights_from", fields: [from_id], references: [id])
  to       airport?  @relation("flights_to", fields: [to_id], references: [id])
  aircraft aircraft? @relation(fields: [aircraft_id], references: [id])
  airline  airline?  @relation(fields: [airline_id], references: [id])
  seats    seat[]

  @@index([from_id], map: "flight_from_id_idx")
  @@index([to_id], map: "flight_to_id_idx")
}

model seat {
  id         Int     @id @default(autoincrement())
  flight_id  Int
  user_id    String?
  guest_name String?

  /// @kyselyType('window' | 'aisle' | 'middle' | 'pilot' | 'copilot' | 'jumpseat' | 'other')
  seat        String?
  /// Seat number (e.g. 12A)
  seat_number String?
  /// @kyselyType('economy' | 'economy+' | 'business' | 'first' | 'private')
  seat_class  String?

  user   user?  @relation(fields: [user_id], references: [id], onDelete: Cascade)
  flight flight @relation(fields: [flight_id], references: [id], onDelete: Cascade)

  @@unique([flight_id, user_id], map: "seat_user_id_flight_id_key")
  @@unique([flight_id, guest_name], map: "seat_flight_id_guest_name_key")
}

model visited_country {
  id Int @id @default(autoincrement())

  /// ISO 3166-1 numeric code
  code   Int
  /// @kyselyType('lived' | 'visited' | 'layover' | 'wishlist')
  status String
  note   String?

  user_id String
  user    user   @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([code, user_id], map: "visited_country_code_user_id_key")
}

model session {
  id         String   @id
  expires_at DateTime @db.Timestamptz
  user_id    String
  user       user     @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model api_key {
  id         Int       @id @default(autoincrement())
  name       String
  user_id    String
  key        String
  created_at DateTime  @default(now()) @db.Timestamptz
  last_used  DateTime? @db.Timestamptz

  user user @relation(fields: [user_id], references: [id], onDelete: Cascade)
}

model public_share {
  id         Int       @id @default(autoincrement())
  user_id    String
  slug       String    @unique
  expires_at DateTime? @db.Timestamptz
  created_at DateTime  @default(now()) @db.Timestamptz

  // Privacy settings
  show_map         Boolean @default(true)
  show_stats       Boolean @default(false)
  show_flight_list Boolean @default(false)

  // Flight filtering
  date_from String? // YYYY-MM-DD
  date_to   String? // YYYY-MM-DD

  // Data privacy settings
  show_flight_numbers Boolean @default(true)
  show_airlines       Boolean @default(true)
  show_aircraft       Boolean @default(false)
  show_times          Boolean @default(false)
  show_dates          Boolean @default(true)
  show_seat           Boolean @default(false)

  user user @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([user_id])
}
