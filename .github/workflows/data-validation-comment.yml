name: Data Validation Comment

on:
  workflow_run:
    workflows:
      - Data Validation
    types:
      - completed

permissions:
  actions: read
  contents: read
  pull-requests: write

jobs:
  comment:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.event == 'pull_request' }}
    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@91182cccc01eb5e619899d80e4e971d6181294a7 # v2.10.1
        with:
          egress-policy: audit

      - name: Download comment artifact
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          name: data-validation-comment
          path: .

      - name: Post PR comment
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7
        with:
          script: |
            const fs = require('fs');

            const workflowRun = context.payload.workflow_run;
            let pullRequests = workflowRun.pull_requests || [];

            if (pullRequests.length === 0) {
              const headRepo = workflowRun.head_repository;
              const headOwner = headRepo?.owner?.login;
              const headBranch = workflowRun.head_branch;

              if (headOwner && headBranch) {
                const { data } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: `${headOwner}:${headBranch}`,
                  state: 'open',
                });
                pullRequests = data;
              }
            }

            if (pullRequests.length === 0) {
              core.info('No pull request found.');
              return;
            }

            const issueNumber = pullRequests[0].number;
            const body = fs.readFileSync('comment.md', 'utf8');

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' && comment.body.includes('Data Validation')
            );

            if (botComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
              });
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body,
            });
